plugins {
    alias(libs.plugins.android.application) apply false
    alias(libs.plugins.hilt.android) apply false
    alias(libs.plugins.versions)
}

// Top-level build file where you can add configuration options common to all sub-projects/modules.

allprojects {
    repositories {
        google()
        mavenCentral()
    }
}

tasks.register('clean', Delete) {
    delete getLayout().getBuildDirectory()
}

// Build verification task - to check if build is healthy
tasks.register('buildHealthCheck') {
    group = 'verification'
    description = 'Performs a health check on the build configuration and dependencies'
    
    doLast {
        println "\n========================================="
        println "ðŸ¥ Build Health Check Report"
        println "========================================="
        
        // Check Gradle version
        def gradleVersion = gradle.gradleVersion
        println "âœ… Gradle Version: ${gradleVersion}"
        
        // Check AGP version
        println "âœ… Android Gradle Plugin: Configured"
        
        // Check if all repositories are accessible
        println "âœ… Repositories configured: ${allprojects.collect { it.repositories.size() }.sum()}"
        
        println "\nðŸ“¦ Project Structure:"
        println "   - Root Project: ${rootProject.name}"
        subprojects.each { subproject ->
            println "   - Subproject: ${subproject.name}"
        }
        
        println "\nâœ… Build configuration looks healthy!"
        println "=========================================\n"
    }
}

// Dependency verification task
tasks.register('verifyDependencies') {
    group = 'verification'
    description = 'Verifies that all dependencies can be resolved'
    
    doLast {
        println "\n========================================="
        println "ðŸ“¦ Dependency Verification"
        println "========================================="
        
        def allResolved = true
        // Configuration patterns to check for better reliability
        def configPatterns = ['implementation', 'testImplementation', 'androidTestImplementation', 'RuntimeClasspath']
        
        subprojects.each { subproject ->
            println "\nChecking dependencies for: ${subproject.name}"
            
            try {
                subproject.configurations.each { config ->
                    // Only check essential configurations to improve performance
                    def shouldCheck = configPatterns.any { pattern -> 
                        config.name == pattern || config.name.endsWith(pattern.capitalize())
                    }
                    
                    if (config.canBeResolved && shouldCheck) {
                        config.resolve()
                    }
                }
                println "âœ… All dependencies resolved successfully"
            } catch (Exception e) {
                println "âŒ Failed to resolve dependencies: ${e.message}"
                allResolved = false
            }
        }
        
        if (allResolved) {
            println "\nâœ… All dependencies verified successfully!"
        } else {
            println "\nâš ï¸  Some dependencies could not be resolved"
            throw new GradleException("Dependency verification failed")
        }
        println "=========================================\n"
    }
}

// Complete build verification
tasks.register('fullBuildVerification') {
    group = 'verification'
    description = 'Runs complete build verification including health check, dependency verification, lint, and tests'
    
    dependsOn 'buildHealthCheck'
    dependsOn 'clean'
    dependsOn 'build'
    
    // Ensure proper execution order
    def cleanTask = tasks.findByName('clean')
    def buildTask = tasks.findByName('build')
    
    if (cleanTask != null && buildTask != null) {
        cleanTask.mustRunAfter('buildHealthCheck')
        buildTask.mustRunAfter('clean')
    }
    
    doLast {
        println "\n========================================="
        println "âœ… FULL BUILD VERIFICATION COMPLETED"
        println "========================================="
        println "All checks passed successfully!"
        println "=========================================\n"
    }
}

dependencyUpdates {
    def isNonStable = { String version ->
        def stableKeyword = ['RELEASE', 'FINAL', 'GA'].any { version.toUpperCase().contains(it) }
        def stableRegex = /^[0-9,.v-]+(-r)?$/
        return !stableKeyword && !(version ==~ stableRegex)
    }

    rejectVersionIf {
        isNonStable(it.candidate.version) && !isNonStable(it.currentVersion)
    }
}
